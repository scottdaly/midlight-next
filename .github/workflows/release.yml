name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

env:
  CARGO_INCREMENTAL: 0

jobs:
  build-macos:
    name: Build macOS
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin,x86_64-apple-darwin

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: apps/desktop/src-tauri

      - name: Install dependencies
        run: pnpm install

      - name: Build workspace packages
        run: pnpm build

      - name: Import Apple signing certificate
        env:
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        run: |
          # Create temporary keychain
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          KEYCHAIN_PASSWORD=$(openssl rand -base64 32)

          # Decode certificate
          echo "$APPLE_CERTIFICATE" | base64 --decode > $RUNNER_TEMP/certificate.p12

          # Create and configure keychain
          security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

          # Import certificate
          security import $RUNNER_TEMP/certificate.p12 -P "$APPLE_CERTIFICATE_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
          security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

          # Add to search list
          security list-keychain -d user -s $KEYCHAIN_PATH login.keychain-db

          # Verify
          security find-identity -v -p codesigning $KEYCHAIN_PATH

      - name: Build Tauri App (Universal Binary)
        run: pnpm tauri build --target universal-apple-darwin
        working-directory: apps/desktop
        env:
          APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-release
          path: |
            apps/desktop/src-tauri/target/universal-apple-darwin/release/bundle/dmg/*.dmg
            apps/desktop/src-tauri/target/universal-apple-darwin/release/bundle/macos/*.app.tar.gz
            apps/desktop/src-tauri/target/universal-apple-darwin/release/bundle/macos/*.app.tar.gz.sig

  build-windows:
    name: Build Windows
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: apps/desktop/src-tauri

      - name: Install dependencies
        run: pnpm install

      - name: Build workspace packages
        run: pnpm build

      - name: Build Tauri App
        run: pnpm tauri build
        working-directory: apps/desktop
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}

      - name: Sign Windows MSI with Trusted Signing
        uses: azure/trusted-signing-action@v0.5.0
        with:
          azure-tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          azure-client-id: ${{ secrets.AZURE_CLIENT_ID }}
          azure-client-secret: ${{ secrets.AZURE_CLIENT_SECRET }}
          endpoint: ${{ secrets.AZURE_ENDPOINT }}
          trusted-signing-account-name: ${{ secrets.AZURE_SIGNING_ACCOUNT }}
          certificate-profile-name: ${{ secrets.AZURE_CERT_PROFILE_NAME }}
          files-folder: apps/desktop/src-tauri/target/release/bundle/msi
          files-folder-filter: msi
          file-digest: SHA256
          timestamp-rfc3161: http://timestamp.acs.microsoft.com
          timestamp-digest: SHA256

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-release
          path: |
            apps/desktop/src-tauri/target/release/bundle/msi/*.msi
            apps/desktop/src-tauri/target/release/bundle/msi/*.msi.sig
            apps/desktop/src-tauri/target/release/bundle/nsis/*.exe

  build-linux:
    name: Build Linux
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: apps/desktop/src-tauri

      - name: Install dependencies
        run: pnpm install

      - name: Build workspace packages
        run: pnpm build

      - name: Build Tauri App
        run: pnpm tauri build
        working-directory: apps/desktop
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-release
          path: |
            apps/desktop/src-tauri/target/release/bundle/appimage/*.AppImage
            apps/desktop/src-tauri/target/release/bundle/appimage/*.AppImage.sig
            apps/desktop/src-tauri/target/release/bundle/deb/*.deb

  deploy:
    name: Deploy to midlight.ai
    needs: [build-macos, build-windows, build-linux]
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare deploy directory
        run: |
          mkdir -p deploy
          # Find and copy all release files
          find artifacts -type f \( -name "*.dmg" -o -name "*.msi" -o -name "*.exe" -o -name "*.AppImage" -o -name "*.deb" -o -name "*.sig" -o -name "*.tar.gz" \) -exec cp {} deploy/ \;
          ls -la deploy/

      - name: Get version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Rename artifacts with version
        run: |
          VERSION=${{ steps.version.outputs.version }}
          cd deploy

          # Rename macOS files
          for f in *.dmg; do
            [ -f "$f" ] && mv "$f" "midlight-next-$VERSION-macos.dmg" && echo "Renamed $f"
          done
          for f in *.app.tar.gz; do
            [ -f "$f" ] && mv "$f" "midlight-next-$VERSION-macos.app.tar.gz" && echo "Renamed $f"
          done
          for f in *.app.tar.gz.sig; do
            [ -f "$f" ] && mv "$f" "midlight-next-$VERSION-macos.app.tar.gz.sig" && echo "Renamed $f"
          done

          # Rename Windows files
          for f in *.msi; do
            [ -f "$f" ] && mv "$f" "midlight-next-$VERSION-windows.msi" && echo "Renamed $f"
          done
          for f in *.msi.sig; do
            [ -f "$f" ] && mv "$f" "midlight-next-$VERSION-windows.msi.sig" && echo "Renamed $f"
          done
          for f in *.exe; do
            [ -f "$f" ] && mv "$f" "midlight-next-$VERSION-windows.exe" && echo "Renamed $f"
          done

          # Rename Linux files
          for f in *.AppImage; do
            [ -f "$f" ] && mv "$f" "midlight-next-$VERSION-linux.AppImage" && echo "Renamed $f"
          done
          for f in *.AppImage.sig; do
            [ -f "$f" ] && mv "$f" "midlight-next-$VERSION-linux.AppImage.sig" && echo "Renamed $f"
          done
          for f in *.deb; do
            [ -f "$f" ] && mv "$f" "midlight-next-$VERSION-linux.deb" && echo "Renamed $f"
          done

          ls -la

      - name: Generate tauri-latest.json
        run: |
          VERSION=${{ steps.version.outputs.version }}

          # Read signatures if they exist
          MAC_SIG=""
          WIN_SIG=""
          LINUX_SIG=""

          if [ -f "deploy/midlight-next-$VERSION-macos.app.tar.gz.sig" ]; then
            MAC_SIG=$(cat "deploy/midlight-next-$VERSION-macos.app.tar.gz.sig")
          fi
          if [ -f "deploy/midlight-next-$VERSION-windows.msi.sig" ]; then
            WIN_SIG=$(cat "deploy/midlight-next-$VERSION-windows.msi.sig")
          fi
          if [ -f "deploy/midlight-next-$VERSION-linux.AppImage.sig" ]; then
            LINUX_SIG=$(cat "deploy/midlight-next-$VERSION-linux.AppImage.sig")
          fi

          cat > deploy/tauri-latest.json << EOF
          {
            "version": "$VERSION",
            "notes": "See release notes at https://midlight.ai/changelog",
            "pub_date": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "platforms": {
              "darwin-universal": {
                "signature": "$MAC_SIG",
                "url": "https://midlight.ai/releases/midlight-next-$VERSION-macos.app.tar.gz"
              },
              "darwin-x86_64": {
                "signature": "$MAC_SIG",
                "url": "https://midlight.ai/releases/midlight-next-$VERSION-macos.app.tar.gz"
              },
              "darwin-aarch64": {
                "signature": "$MAC_SIG",
                "url": "https://midlight.ai/releases/midlight-next-$VERSION-macos.app.tar.gz"
              },
              "windows-x86_64": {
                "signature": "$WIN_SIG",
                "url": "https://midlight.ai/releases/midlight-next-$VERSION-windows.msi"
              },
              "linux-x86_64": {
                "signature": "$LINUX_SIG",
                "url": "https://midlight.ai/releases/midlight-next-$VERSION-linux.AppImage"
              }
            }
          }
          EOF

          echo "Generated tauri-latest.json:"
          cat deploy/tauri-latest.json

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.DEPLOY_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to server
        run: |
          scp -i ~/.ssh/deploy_key deploy/* ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}:/var/www/midlight-releases/
          echo "Deployed files:"
          ssh -i ~/.ssh/deploy_key ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} "ls -la /var/www/midlight-releases/midlight-next-*"
